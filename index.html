<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>My Mapbox Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    body { margin: 0; padding: 0; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    #filters {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 2;
      background: white;
      padding: 10px;
      font-family: sans-serif;
      max-height: 90vh;
      overflow-y: auto;
    }
    #sidebar {
      position: absolute;
      top: 200px;
      right: 10px;
      bottom: 10px;
      width: 250px;
      background: white;
      padding: 10px;
      border-radius: 4px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.3);
      overflow-y: auto;
      z-index: 2;
      font-family: sans-serif;
      font-size: 14px;
    }
    #sidebar h4 {
      margin: 8px 0 4px;
      font-size: 16px;
      font-weight: bold;
    }
    #sidebar ul { list-style: none; padding: 0; margin: 0 0 10px; }
    #sidebar li { cursor: pointer; padding: 4px; border-bottom: 1px solid #eee; }
    #sidebar li:hover { background: #f0f0f0; }
    #map-title {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 3;
      background: rgba(255, 255, 255, 0.9);
      padding: 8px 16px;
      font-family: sans-serif;
      font-size: 20px;
      font-weight: bold;
      border-radius: 4px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.3);
    }
    #map-title a {
      text-decoration: none;
      color: inherit;
    }
  </style>
</head>
<body>
<div id="map-title"><a href="about.html" target="_blank">Wonderful World of Wildlife Crossings</a></div>
<div id="map"></div>

<div id="filters">
  <label>Status:</label>
  <select id="filter-status">
    <option value="">All</option>
    <option>Planned Structure</option>
    <option>Completed Structure</option>
    <option>Statewide Analysis</option>
  </select><br>

  <label>Detail:</label>
  <select id="filter-detail">
    <option value="">All</option>
    <option>Case Study</option>
    <option>Technical Specifications</option>
  </select><br>

  <label>Funding:</label>
  <select id="filter-funding">
    <option value="">All</option>
    <option>Wildlife Crossings Pilot Program (WCPP)</option>
    <option>Transportation Alternatives Program</option>
  </select><br>

  <label>Species:</label>
  <select id="filter-species">
    <option value="">All</option>
    <option>Large Mammals</option>
    <option>Ungulates</option>
    <option>Small Mammals</option>
    <option>Reptiles and Amphibians</option>
  </select><br>

  <label>State/Province:</label>
  <select id="filter-region">
    <option value="">All</option>
    <option>California</option>
    <option>Alberta</option>
    <option>Ontario</option>
  </select><br>

  <button id="reset-filters" style="margin-top: 10px; font-family: sans-serif;">Reset Filters</button>
</div>

<div id="sidebar"></div>

<script>
  mapboxgl.accessToken = 'pk.eyJ1IjoiYXJjc29sdXRpb25zIiwiYSI6ImNsbHBpb2E0NTAydTEzZG9hcmVmdGdvaG4ifQ.caa0jV__lbPqAoJxVAZVlA';

  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/light-v10',
    center: [-100, 45],
    zoom: 3
  });
  map.addControl(new mapboxgl.NavigationControl(), 'top-right');

  const regionBounds = {
    'California': [[-124.48, 32.53], [-114.13, 42.01]],
    'Alberta': [[-120, 48.99], [-110, 60]],
    'Ontario': [[-95.16, 41.67], [-74.34, 56.85]]
  };

  const geojson = {
    type: 'FeatureCollection',
    features: [
      { type: 'Feature', properties: { title: 'Crossing A', url: 'project-a.html', type: 'Overpass', status: 'Completed Structure', detail: 'Case Study', funding: 'Wildlife Crossings Pilot Program (WCPP)', species: 'Large Mammals', region: 'California' }, geometry: { type: 'Point', coordinates: [-119.5, 34.2] }},
      { type: 'Feature', properties: { title: 'Crossing B', url: 'project-b.html', type: 'Underpass', status: 'Planned Structure', detail: 'Technical Specifications', funding: 'Transportation Alternatives Program', species: 'Ungulates', region: 'Alberta' }, geometry: { type: 'Point', coordinates: [-114, 51] }}
    ]
  };

  const allMarkers = [];

  function updateSidebar(features) {
    const sidebar = document.getElementById('sidebar');
    sidebar.innerHTML = '';
    const grouped = {};
    features.forEach(f => {
      const region = f.properties.region || 'Unknown';
      if (!grouped[region]) grouped[region] = [];
      grouped[region].push(f);
    });
    Object.keys(grouped).sort().forEach(region => {
      const h4 = document.createElement('h4');
      h4.textContent = region;
      sidebar.appendChild(h4);
      const ul = document.createElement('ul');
      grouped[region].forEach((f, idx) => {
        const li = document.createElement('li');
        li.innerHTML = `<a href="${f.properties.url}" target="_blank">${f.properties.title}</a>`;
        li.addEventListener('click', () => {
          map.flyTo({ center: f.geometry.coordinates, zoom: 8 });
          new mapboxgl.Popup()
            .setLngLat(f.geometry.coordinates)
            .setHTML(`<h4><a href='${f.properties.url}' target='_blank'>${f.properties.title}</a></h4>`)  
            .addTo(map);
        });
        ul.appendChild(li);
      });
      sidebar.appendChild(ul);
    });
  }

  function renderMarkers() {
    const status = document.getElementById('filter-status').value;
    const detail = document.getElementById('filter-detail').value;
    const funding = document.getElementById('filter-funding').value;
    const species = document.getElementById('filter-species').value;
    const region = document.getElementById('filter-region').value;

    allMarkers.forEach(m => m.remove()); allMarkers.length = 0;
    const filtered = geojson.features.filter(f => {
      const matchStatus = !status || f.properties.status === status;
      const matchDetail = !detail || f.properties.detail === detail;
      const matchFunding = !funding || f.properties.funding === funding;
      const matchSpecies = !species || f.properties.species === species;
      const matchRegion = !region || f.properties.region === region;
      return matchStatus && matchDetail && matchFunding && matchSpecies && matchRegion;
    });
    filtered.forEach(feature => {
      const marker = new mapboxgl.Marker()
        .setLngLat(feature.geometry.coordinates)
        .setPopup(new mapboxgl.Popup().setHTML(`
          <h4><a href='${feature.properties.url}' target='_blank'>${feature.properties.title}</a></h4>
          <p><strong>Status:</strong> ${feature.properties.status}</p>
        `))
        .addTo(map);
      allMarkers.push(marker);
    });
    if (region && regionBounds[region]) {
      map.fitBounds(regionBounds[region], { padding: 40 });
    }
    updateSidebar(filtered);
  }

  map.on('load', () => {
    renderMarkers();
    ['filter-status','filter-detail','filter-funding','filter-species','filter-region'].forEach(id => {
      document.getElementById(id).addEventListener('change', renderMarkers);
    });
    document.getElementById('reset-filters').addEventListener('click', () => {
      ['filter-status','filter-detail','filter-funding','filter-species','filter-region'].forEach(id => document.getElementById(id).value='');
      map.flyTo({ center:[-100,45], zoom:3 }); renderMarkers();
    });
  });
</script>
</body>
</html>
